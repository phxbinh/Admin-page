<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Quản lý người dùng</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #f1f1f1; }
    button { padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #c0392b; }
    select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    #loading { text-align: center; padding: 50px; color: #666; }
  </style>
  
</head>
<body>

  <h1>Admin - Quản lý người dùng</h1>

  <div id="loading">Đang tải danh sách...</div>

<!----
  <table id="user-table" style="display:none;">
    <thead>
      <tr>
        <th>Email</th>
        <th>User ID</th>
        <th>Role</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody id="user-body"></tbody>
  </table>
<!---->
   <div id="app"></div>
  <!-- Load VDOM -->
  <script src="./Debugger.js"></script>
<script src="./vdom.js"></script>
<script src="./hooks.js"></script>
<script src="./router.js"></script>
<script src="./init_API.js"></script>

  
  <script>
 
function AdminUsersPage() {
  const { h } = window.App.VDOM;
  const { useState, useEffect } = window.App.Hooks;

  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  // ===============================
  // Load users
  // ===============================
  async function loadUsers() {
    try {
      setLoading(true);
      setError("");

      const res = await fetch("/api/users");
      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || "Fetch users failed");
      }

      setUsers(data);
    } catch (err) {
      setError("Lỗi tải danh sách: " + err.message);
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    loadUsers();
  }, []);

  // ===============================
  // Change role
  // ===============================
  async function changeRole(user, newRole) {
    if (newRole === user.role) return;

    if (!confirm(`Đổi role của ${user.email} thành ${newRole}?`)) {
      return;
    }

    try {
      const res = await fetch("/api/change-role", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: user.id, newRole })
      });

      const data = await res.json();

      if (!data.success) {
        throw new Error(data.error || "Không xác định");
      }

      alert("Đổi role thành công");
      loadUsers(); // reload list
    } catch (err) {
      alert("Lỗi: " + err.message);
    }
  }

  // ===============================
  // Delete user
  // ===============================
  async function deleteUser(user) {
    if (!confirm(`Xóa người dùng ${user.email}?`)) return;

    try {
      const res = await fetch("/api/delete-user", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: user.id })
      });

      const data = await res.json();

      if (!data.success) {
        throw new Error(data.error || "Không xác định");
      }

      alert("Xóa thành công");
      loadUsers();
    } catch (err) {
      alert("Lỗi: " + err.message);
    }
  }

  // ===============================
  // Render states
  // ===============================
  if (loading) {
    return h("div", { id: "loading" }, "Đang tải danh sách...");
  }

  if (error) {
    return h("div", { style: { color: "red", padding: "20px" } }, error);
  }

  // ===============================
  // Render table
  // ===============================
  return h("div", { style: { padding: "20px" } },
    h("h1", { style: { textAlign: "center" } }, "Admin - Quản lý người dùng"),

    h("table", {
      style: {
        width: "100%",
        borderCollapse: "collapse",
        background: "white",
        marginTop: "20px"
      },
      border: 1,
      cellPadding: 10
    },
      h("thead", null,
        h("tr", null,
          h("th", null, "Email"),
          h("th", null, "User ID"),
          h("th", null, "Role"),
          h("th", null, "Thao tác")
        )
      ),

      h("tbody", null,
        users.map(user =>
          h("tr", { key: user.id },

            h("td", null, user.email),

            h("td", null, user.id.slice(0, 8) + "..."),

            h("td", null,
              h("select", {
                value: user.role,
                onChange: e => changeRole(user, e.target.value)
              },
                ["user", "admin", "moderator"].map(role =>
                  h("option", { value: role },
                    role.charAt(0).toUpperCase() + role.slice(1)
                  )
                )
              )
            ),

            h("td", null,
              h("button", {
                onClick: () => deleteUser(user),
                style: {
                  padding: "6px 12px",
                  background: "#e74c3c",
                  color: "white",
                  border: "none",
                  borderRadius: "4px",
                  cursor: "pointer"
                }
              }, "Xóa")
            )
          )
        )
      )
    )
  );
}

window.App.Router.addRoute("/admin/users", AdminUsersPage);
window.App.Router.init(document.getElementById("app"), {hash: false})

</script>
  
  
  
  
  
  
  
  
</body>
</html>