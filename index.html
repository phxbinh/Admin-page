<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Quản lý người dùng</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f9f9f9; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #f1f1f1; }
    button { padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #c0392b; }
    select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    #loading { text-align: center; padding: 50px; color: #666; }
  </style>
  
  
  <!-- INIT SUPABASE TRƯỚC --
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  window.supabase = createClient(
    'https://defkqhylqphoqiikvbii.supabase.co',
    'sb_publishable_vzdQpgqjLL2VE0Oyc0kEJQ_P8XqBwkh'
  );

  console.log('Supabase READY');
  </script>
  <!---->
  
</head>
<body>

  <h1>Admin - Quản lý người dùng</h1>

  <div id="loading">Đang tải danh sách...</div>

  <table id="user-table" style="display:none;">
    <thead>
      <tr>
        <th>Email</th>
        <th>User ID</th>
        <th>Role</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody id="user-body"></tbody>
  </table>

  <!-- Load VDOM -->
  <script src="./Debugger.js"></script>
<script src="./vdom.js"></script>
<script src="./hooks.js"></script>
<script src="./router.js"></script>
<script src="./init_API.js"></script>

  <script>
    // ==========================================
    // Hardcode mock data trước (sau này thay bằng fetch)
    // ==========================================
    const mockUsers = [
      { id: 'uuid-001', email: 'user1@example.com', role: 'user' },
      { id: 'uuid-002', email: 'admin2@example.com', role: 'admin' },
      { id: 'uuid-003', email: 'test3@gmail.com', role: 'user' },
      { id: 'uuid-004', email: 'demo4@site.vn', role: 'moderator' }
    ];

    // ==========================================
    // Render bằng VDOM (khi có dữ liệu)
    // ==========================================
    function renderUsers(users = mockUsers) {
      const { h, render } = window.App.VDOM;

      const tableBody = document.getElementById('user-body');
      tableBody.innerHTML = ''; // clear trước

      users.forEach(user => {
        const row = h('tr', {},
          h('td', {}, user.email),
          h('td', {}, user.id.substring(0, 8) + '...'),
          h('td', {},
            // Role select
            h('select', {
              value: user.role,
              onchange: e => {
                const newRole = e.target.value;
                if (newRole === user.role) return;
                if (confirm(`Đổi role của ${user.email} thành ${newRole}?`)) {
                  fetch('/api/change-role', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id, newRole })
                  })
                  .then(r => r.json())
                  .then(data => {
                    if (data.success) {
                      alert('Đổi role thành công');
                      location.reload(); // đơn giản nhất
                    } else {
                      alert('Lỗi: ' + (data.error || 'Không xác định'));
                    }
                  })
                  .catch(err => alert('Lỗi mạng: ' + err.message));
                }
              }
            },
              h('option', { value: 'user' }, 'User'),
              h('option', { value: 'admin' }, 'Admin'),
              h('option', { value: 'moderator' }, 'Moderator')
            )
          ),
          h('td', {},
            // Delete button
            h('button', {
              onclick: () => {
                if (confirm(`Xóa người dùng ${user.email}?`)) {
                  fetch('/api/delete-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id })
                  })
                  .then(r => r.json())
                  .then(data => {
                    if (data.success) {
                      alert('Xóa thành công');
                      location.reload();
                    } else {
                      alert('Lỗi: ' + (data.error || 'Không xác định'));
                    }
                  })
                  .catch(err => alert('Lỗi mạng: ' + err.message));
                }
              }
            }, 'Xóa')
          )
        );

        // Mount row vào tbody bằng VDOM
        const tr = document.createElement('tr');
        tableBody.appendChild(tr);
        render(() => row, tr);
      });

      document.getElementById('loading').style.display = 'none';
      document.getElementById('user-table').style.display = 'table';
    }

    // ==========================================
    // Khởi động
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
      // Hardcode mode: render ngay mock data
      renderUsers();

      // Khi sẵn sàng dùng Supabase thật:
      // fetch('/api/users')
      //   .then(r => r.json())
      //   .then(data => renderUsers(data))
      //   .catch(err => {
      //     document.getElementById('loading').textContent = 'Lỗi tải dữ liệu: ' + err.message;
      //   });
    });
  </script>
</body>
</html>